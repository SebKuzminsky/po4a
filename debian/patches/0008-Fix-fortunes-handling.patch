From: "Dr. Tobias Quathamer" <toddy@debian.org>
Date: Thu, 7 Jun 2018 10:33:06 +0200
Subject: Fix fortunes handling.

This patch is already included upstream and
can be dropped with v0.54.

Closes: #900649
---
 lib/Locale/Po4a/Text.pm       | 36 ++++++++++++++++-----
 t/33-fortunes.t               | 61 ++++++++++++++++++++++++++++++++++++
 t/data-33/MultipleLines.err   |  0
 t/data-33/MultipleLines.out   | 23 ++++++++++++++
 t/data-33/MultipleLines.po    | 73 +++++++++++++++++++++++++++++++++++++++++++
 t/data-33/MultipleLines.txt   | 23 ++++++++++++++
 t/data-33/SeveralFortunes.err |  0
 t/data-33/SeveralFortunes.out |  5 +++
 t/data-33/SeveralFortunes.po  | 35 +++++++++++++++++++++
 t/data-33/SeveralFortunes.txt |  5 +++
 t/data-33/SingleFortune.err   |  0
 t/data-33/SingleFortune.out   |  1 +
 t/data-33/SingleFortune.po    | 23 ++++++++++++++
 t/data-33/SingleFortune.txt   |  1 +
 14 files changed, 279 insertions(+), 7 deletions(-)
 create mode 100644 t/33-fortunes.t
 create mode 100644 t/data-33/MultipleLines.err
 create mode 100644 t/data-33/MultipleLines.out
 create mode 100644 t/data-33/MultipleLines.po
 create mode 100644 t/data-33/MultipleLines.txt
 create mode 100644 t/data-33/SeveralFortunes.err
 create mode 100644 t/data-33/SeveralFortunes.out
 create mode 100644 t/data-33/SeveralFortunes.po
 create mode 100644 t/data-33/SeveralFortunes.txt
 create mode 100644 t/data-33/SingleFortune.err
 create mode 100644 t/data-33/SingleFortune.out
 create mode 100644 t/data-33/SingleFortune.po
 create mode 100644 t/data-33/SingleFortune.txt

diff --git a/lib/Locale/Po4a/Text.pm b/lib/Locale/Po4a/Text.pm
index 77daa22..b2e86ba 100644
--- a/lib/Locale/Po4a/Text.pm
+++ b/lib/Locale/Po4a/Text.pm
@@ -333,16 +333,38 @@ sub parse_debianchangelog {
 
 sub parse_fortunes {
     my ($self,$line,$ref,$paragraph,$wrapped_mode,$expect_header,$end_of_paragraph) = @_;
-    if ($line =~ m/^%%?\s*$/) {
-        # Found end of fortune
+    # Always include paragraphs in no-wrap mode,
+    # because the formatting of the fortunes
+    # is usually hand-crafted and matters.
+    $wrapped_mode = 0;
+    # Check if there are more lines in the file.
+    my $last_line_of_file = 0;
+    my ($nextline,$nextref) = $self->shiftline();
+    if (defined $nextline) {
+        # There is a next line, put it back.
+        $self->unshiftline($nextline, $nextref);
+    } else {
+        # Nope, no more lines available.
+        $last_line_of_file = 1;
+    }
+    # Is the line the end of a fortune or the last line of the file?
+    if ($line =~ m/^%%?\s*$/ or $last_line_of_file) {
+        # Add the last line to the paragraph
+        if ($last_line_of_file) {
+            $paragraph .= $line;
+        }
+        # Remove the last newline for the translation.
+        chomp($paragraph);
         do_paragraph($self,$paragraph,$wrapped_mode);
-        $self->pushline("\n") unless (   $wrapped_mode == 0
-                                  or $paragraph eq "");
         $paragraph="";
-        $wrapped_mode = 1;
-        $self->pushline("$line\n");
+        # Add the last newline again for the output.
+        $self->pushline("\n");
+        # Also add the separator line, if this is not the end of the file.
+        if (!$last_line_of_file) {
+            $self->pushline("$line\n");
+        }
     } else {
-        $line =~ s/%%(.*)$//;
+        $paragraph .= $line."\n";
     }
     return ($paragraph,$wrapped_mode,$expect_header,$end_of_paragraph);
 }
diff --git a/t/33-fortunes.t b/t/33-fortunes.t
new file mode 100644
index 0000000..0d7ab5b
--- /dev/null
+++ b/t/33-fortunes.t
@@ -0,0 +1,61 @@
+#! /usr/bin/perl
+# Text module tester for fortunes files.
+
+#########################
+
+use strict;
+use warnings;
+
+my @tests;
+
+unless (-e "t/tmp") {
+    mkdir "t/tmp"
+        or die "Can't create test directory t/tmp: $!\n";
+}
+
+my @FortunesTests = qw(SingleFortune SeveralFortunes MultipleLines);
+
+foreach my $FortunesTest (@FortunesTests) {
+    push @tests, {
+        'run' => "perl ../../po4a-normalize -f text -o fortunes ../data-33/$FortunesTest.txt >$FortunesTest.err 2>&1".
+	         "&& mv po4a-normalize.po $FortunesTest.po ".
+	         "&& mv po4a-normalize.output $FortunesTest.out ",
+        'test'=> "perl ../compare-po.pl --no-ref ../data-33/$FortunesTest.po $FortunesTest.po ".
+                 "&& diff -u ../data-33/$FortunesTest.out $FortunesTest.out 1>&2".
+	         "&& diff -u ../data-33/$FortunesTest.err $FortunesTest.err 1>&2",
+        'doc' => "$FortunesTest test"
+    };
+}
+
+use Test::More tests => 3 * 2;
+
+chdir "t/tmp" || die "Can't chdir to my test directory";
+
+foreach my $test ( @tests ) {
+    my ($val,$name);
+
+    my $cmd=$test->{'run'};
+    $val=system($cmd);
+
+    $name=$test->{'doc'}.' runs';
+    ok($val == 0,$name);
+    diag($test->{'run'}) unless ($val == 0);
+
+    SKIP: {
+        skip ("Command didn't run, can't test the validity of its return",1)
+          if $val;
+        $val=system($test->{'test'});
+        $name=$test->{'doc'}.' returns what is expected';
+        ok($val == 0,$name);
+        unless ($val == 0) {
+            diag ("Failed (retval=$val) on:");
+            diag ($test->{'test'});
+            diag ("Was created with:");
+            diag ($test->{'run'});
+        }
+    }
+}
+
+chdir "../.." || die "Can't chdir back to my root";
+
+0;
diff --git a/t/data-33/MultipleLines.err b/t/data-33/MultipleLines.err
new file mode 100644
index 0000000..e69de29
diff --git a/t/data-33/MultipleLines.out b/t/data-33/MultipleLines.out
new file mode 100644
index 0000000..720b241
--- /dev/null
+++ b/t/data-33/MultipleLines.out
@@ -0,0 +1,23 @@
+This is the first line,
+here comes the second line.
+%
+And here is yet another wisdom.
+%
+Now it gets tricky:
+
+There's an empty line between
+these two paragraphs.
+
+                        -- Author
+%
+%A fortune might start with
+the % sign.
+%%
+Two % signs should be recognized as separator.
+%
+% And a % sign with a trailing space should be handled well.
+%
+And
+  * some
+  * bullets
+  * as well.
diff --git a/t/data-33/MultipleLines.po b/t/data-33/MultipleLines.po
new file mode 100644
index 0000000..3f8b9b1
--- /dev/null
+++ b/t/data-33/MultipleLines.po
@@ -0,0 +1,73 @@
+# SOME DESCRIPTIVE TITLE
+# Copyright (C) YEAR Free Software Foundation, Inc.
+# This file is distributed under the same license as the PACKAGE package.
+# FIRST AUTHOR <EMAIL@ADDRESS>, YEAR.
+#
+#, fuzzy
+msgid ""
+msgstr ""
+"Project-Id-Version: PACKAGE VERSION\n"
+"POT-Creation-Date: 2018-06-04 17:30+0000\n"
+"PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n"
+"Last-Translator: FULL NAME <EMAIL@ADDRESS>\n"
+"Language-Team: LANGUAGE <LL@li.org>\n"
+"Language: \n"
+"MIME-Version: 1.0\n"
+"Content-Type: text/plain; charset=CHARSET\n"
+"Content-Transfer-Encoding: 8bit\n"
+
+#. type: Plain text
+#: ../data-33/MultipleLines.txt:1
+#, no-wrap
+msgid ""
+"This is the first line,\n"
+"here comes the second line."
+msgstr ""
+
+#. type: Plain text
+#: ../data-33/MultipleLines.txt:4
+#, no-wrap
+msgid "And here is yet another wisdom."
+msgstr ""
+
+#. type: Plain text
+#: ../data-33/MultipleLines.txt:6
+#, no-wrap
+msgid ""
+"Now it gets tricky:\n"
+"\n"
+"There's an empty line between\n"
+"these two paragraphs.\n"
+"\n"
+"                        -- Author"
+msgstr ""
+
+#. type: Plain text
+#: ../data-33/MultipleLines.txt:13
+#, no-wrap
+msgid ""
+"%A fortune might start with\n"
+"the % sign."
+msgstr ""
+
+#. type: Plain text
+#: ../data-33/MultipleLines.txt:16
+#, no-wrap
+msgid "Two % signs should be recognized as separator."
+msgstr ""
+
+#. type: Plain text
+#: ../data-33/MultipleLines.txt:18
+#, no-wrap
+msgid "% And a % sign with a trailing space should be handled well."
+msgstr ""
+
+#. type: Plain text
+#: ../data-33/MultipleLines.txt:20
+#, no-wrap
+msgid ""
+"And\n"
+"  * some\n"
+"  * bullets\n"
+"  * as well."
+msgstr ""
diff --git a/t/data-33/MultipleLines.txt b/t/data-33/MultipleLines.txt
new file mode 100644
index 0000000..720b241
--- /dev/null
+++ b/t/data-33/MultipleLines.txt
@@ -0,0 +1,23 @@
+This is the first line,
+here comes the second line.
+%
+And here is yet another wisdom.
+%
+Now it gets tricky:
+
+There's an empty line between
+these two paragraphs.
+
+                        -- Author
+%
+%A fortune might start with
+the % sign.
+%%
+Two % signs should be recognized as separator.
+%
+% And a % sign with a trailing space should be handled well.
+%
+And
+  * some
+  * bullets
+  * as well.
diff --git a/t/data-33/SeveralFortunes.err b/t/data-33/SeveralFortunes.err
new file mode 100644
index 0000000..e69de29
diff --git a/t/data-33/SeveralFortunes.out b/t/data-33/SeveralFortunes.out
new file mode 100644
index 0000000..03bdb04
--- /dev/null
+++ b/t/data-33/SeveralFortunes.out
@@ -0,0 +1,5 @@
+This is the first line.
+%
+Here is another fortune.
+%
+And here is yet another wisdom.
diff --git a/t/data-33/SeveralFortunes.po b/t/data-33/SeveralFortunes.po
new file mode 100644
index 0000000..d9bcb14
--- /dev/null
+++ b/t/data-33/SeveralFortunes.po
@@ -0,0 +1,35 @@
+# SOME DESCRIPTIVE TITLE
+# Copyright (C) YEAR Free Software Foundation, Inc.
+# This file is distributed under the same license as the PACKAGE package.
+# FIRST AUTHOR <EMAIL@ADDRESS>, YEAR.
+#
+#, fuzzy
+msgid ""
+msgstr ""
+"Project-Id-Version: PACKAGE VERSION\n"
+"POT-Creation-Date: 2018-06-04 17:30+0000\n"
+"PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n"
+"Last-Translator: FULL NAME <EMAIL@ADDRESS>\n"
+"Language-Team: LANGUAGE <LL@li.org>\n"
+"Language: \n"
+"MIME-Version: 1.0\n"
+"Content-Type: text/plain; charset=CHARSET\n"
+"Content-Transfer-Encoding: 8bit\n"
+
+#. type: Plain text
+#: ../data-33/SeveralFortunes.txt:1
+#, no-wrap
+msgid "This is the first line."
+msgstr ""
+
+#. type: Plain text
+#: ../data-33/SeveralFortunes.txt:3
+#, no-wrap
+msgid "Here is another fortune."
+msgstr ""
+
+#. type: Plain text
+#: ../data-33/SeveralFortunes.txt:6
+#, no-wrap
+msgid "And here is yet another wisdom."
+msgstr ""
diff --git a/t/data-33/SeveralFortunes.txt b/t/data-33/SeveralFortunes.txt
new file mode 100644
index 0000000..03bdb04
--- /dev/null
+++ b/t/data-33/SeveralFortunes.txt
@@ -0,0 +1,5 @@
+This is the first line.
+%
+Here is another fortune.
+%
+And here is yet another wisdom.
diff --git a/t/data-33/SingleFortune.err b/t/data-33/SingleFortune.err
new file mode 100644
index 0000000..e69de29
diff --git a/t/data-33/SingleFortune.out b/t/data-33/SingleFortune.out
new file mode 100644
index 0000000..35ec1de
--- /dev/null
+++ b/t/data-33/SingleFortune.out
@@ -0,0 +1 @@
+This is only one line.
diff --git a/t/data-33/SingleFortune.po b/t/data-33/SingleFortune.po
new file mode 100644
index 0000000..44eb261
--- /dev/null
+++ b/t/data-33/SingleFortune.po
@@ -0,0 +1,23 @@
+# SOME DESCRIPTIVE TITLE
+# Copyright (C) YEAR Free Software Foundation, Inc.
+# This file is distributed under the same license as the PACKAGE package.
+# FIRST AUTHOR <EMAIL@ADDRESS>, YEAR.
+#
+#, fuzzy
+msgid ""
+msgstr ""
+"Project-Id-Version: PACKAGE VERSION\n"
+"POT-Creation-Date: 2018-06-04 17:30+0000\n"
+"PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n"
+"Last-Translator: FULL NAME <EMAIL@ADDRESS>\n"
+"Language-Team: LANGUAGE <LL@li.org>\n"
+"Language: \n"
+"MIME-Version: 1.0\n"
+"Content-Type: text/plain; charset=CHARSET\n"
+"Content-Transfer-Encoding: 8bit\n"
+
+#. type: Plain text
+#: ../data-33/SingleFortune.txt:1
+#, no-wrap
+msgid "This is only one line."
+msgstr ""
diff --git a/t/data-33/SingleFortune.txt b/t/data-33/SingleFortune.txt
new file mode 100644
index 0000000..35ec1de
--- /dev/null
+++ b/t/data-33/SingleFortune.txt
@@ -0,0 +1 @@
+This is only one line.
