From: Martin Quinson <martin.quinson@loria.fr>
Date: Sat, 26 May 2018 17:53:42 +0200
Subject: dedupplicate the references in the PO files

Cherry-picked from upstream commit 79e6495e07f2fc7dbf42152421599ddba0e3ca6a
---
 lib/Locale/Po4a/Po.pm   | 8 ++++++--
 t/data-12/file.pot      | 2 +-
 t/data-12/file_wrap.pot | 3 +--
 t/data-12/full.pot      | 2 +-
 t/data-12/full_wrap.pot | 3 +--
 t/data-23/dot1.pot      | 2 +-
 t/data-23/quotes.pot    | 2 +-
 7 files changed, 12 insertions(+), 10 deletions(-)

diff --git a/lib/Locale/Po4a/Po.pm b/lib/Locale/Po4a/Po.pm
index dbea146..3fc93c7 100644
--- a/lib/Locale/Po4a/Po.pm
+++ b/lib/Locale/Po4a/Po.pm
@@ -1246,7 +1246,7 @@ sub push_raw {
 
     return unless defined($entry{'msgid'});
 
-    #no msgid => header definition
+    # no msgid => header definition
     unless (length($entry{'msgid'})) {
 #       if (defined($self->{header}) && $self->{header} =~ /\S/) {
 #           warn dgettext("po4a","Redefinition of the header. ".
@@ -1332,7 +1332,11 @@ sub push_raw {
     }
     if (defined($reference) && length($reference)) {
         if (defined $self->{po}{$msgid}{'reference'}) {
-            $self->{po}{$msgid}{'reference'} .= " ".$reference;
+	    # Only add the new reference if it's not already included in the existing string
+	    # It'd be much easier if $self->{po}{$msgid}{'reference'} were an array instead of a joined string...
+	    my $oldref = $self->{po}{$msgid}{'reference'};
+            $self->{po}{$msgid}{'reference'} .= " ".$reference
+	      unless (($oldref =~ m/ $reference /) || ($oldref =~ m/ $reference$/) || ($oldref =~ m/^$reference$/) || ($oldref =~ m/^$reference /))
         } else {
             $self->{po}{$msgid}{'reference'} = $reference;
         }
diff --git a/t/data-12/file.pot b/t/data-12/file.pot
index 569c261..c00b71f 100644
--- a/t/data-12/file.pot
+++ b/t/data-12/file.pot
@@ -17,7 +17,7 @@ msgstr ""
 "Content-Transfer-Encoding: 8bit\n"
 
 #. type: TH
-#: ../t/../t/../t/data-02/man ../t/../t/../t/data-03/man ../t/../t/../t/data-03/man ../t/../t/../t/data-12/man02 ../t/../t/../t/data-12/man03 ../t/../t/../t/data-12/man03
+#: ../t/../t/../t/data-02/man ../t/../t/../t/data-03/man ../t/../t/../t/data-12/man02 ../t/../t/../t/data-12/man03
 #, no-wrap
 msgid "test"
 msgstr ""
diff --git a/t/data-12/file_wrap.pot b/t/data-12/file_wrap.pot
index 454794d..badc5d6 100644
--- a/t/data-12/file_wrap.pot
+++ b/t/data-12/file_wrap.pot
@@ -18,8 +18,7 @@ msgstr ""
 
 #. type: TH
 #: ../t/../t/../t/data-02/man ../t/../t/../t/data-03/man
-#: ../t/../t/../t/data-03/man ../t/../t/../t/data-12/man02
-#: ../t/../t/../t/data-12/man03 ../t/../t/../t/data-12/man03
+#: ../t/../t/../t/data-12/man02 ../t/../t/../t/data-12/man03
 #, no-wrap
 msgid "test"
 msgstr ""
diff --git a/t/data-12/full.pot b/t/data-12/full.pot
index 5385c14..7b1db55 100644
--- a/t/data-12/full.pot
+++ b/t/data-12/full.pot
@@ -17,7 +17,7 @@ msgstr ""
 "Content-Transfer-Encoding: 8bit\n"
 
 #. type: TH
-#: ../t/../t/../t/data-02/man:1 ../t/../t/../t/data-03/man:1 ../t/../t/../t/data-03/man:1 ../t/../t/../t/data-12/man02:1 ../t/../t/../t/data-12/man03:1 ../t/../t/../t/data-12/man03:1
+#: ../t/../t/../t/data-02/man:1 ../t/../t/../t/data-03/man:1 ../t/../t/../t/data-12/man02:1 ../t/../t/../t/data-12/man03:1
 #, no-wrap
 msgid "test"
 msgstr ""
diff --git a/t/data-12/full_wrap.pot b/t/data-12/full_wrap.pot
index 060b35c..c7ac0a4 100644
--- a/t/data-12/full_wrap.pot
+++ b/t/data-12/full_wrap.pot
@@ -18,8 +18,7 @@ msgstr ""
 
 #. type: TH
 #: ../t/../t/../t/data-02/man:1 ../t/../t/../t/data-03/man:1
-#: ../t/../t/../t/data-03/man:1 ../t/../t/../t/data-12/man02:1
-#: ../t/../t/../t/data-12/man03:1 ../t/../t/../t/data-12/man03:1
+#: ../t/../t/../t/data-12/man02:1 ../t/../t/../t/data-12/man03:1
 #, no-wrap
 msgid "test"
 msgstr ""
diff --git a/t/data-23/dot1.pot b/t/data-23/dot1.pot
index eabdb5e..81bfcef 100644
--- a/t/data-23/dot1.pot
+++ b/t/data-23/dot1.pot
@@ -16,7 +16,7 @@ msgstr ""
 "Content-Transfer-Encoding: ENCODING"
 
 #. type: TH
-#: data-23/dot1:1 data-23/dot1:1
+#: data-23/dot1:1
 #, no-wrap
 msgid "test"
 msgstr ""
diff --git a/t/data-23/quotes.pot b/t/data-23/quotes.pot
index 9c4a224..38ee6f7 100644
--- a/t/data-23/quotes.pot
+++ b/t/data-23/quotes.pot
@@ -16,7 +16,7 @@ msgstr ""
 "Content-Transfer-Encoding: ENCODING"
 
 #. type: TH
-#: data-23/quotes:1 data-23/quotes:1
+#: data-23/quotes:1
 #, no-wrap
 msgid "test"
 msgstr ""
